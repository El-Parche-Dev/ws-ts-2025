# üîß Eloquent CRUD Operations

**‚è±Ô∏è Tiempo:** 60 minutos (13:45-14:45)  
**üéØ Objetivo:** Dominar operaciones CRUD completas con Eloquent ORM

## üéØ Metodolog√≠a MVP

### üîß FASE CORE (13:45-14:05) - 20 minutos

**Objetivo:** CRUD b√°sico funcionando

**Entregables:**

- Create, Read, Update, Delete b√°sicos
- Controller con m√©todos fundamentales
- Operaciones sin errores

### ‚ö° FASE ENHANCED (14:05-14:25) - 20 minutos

**Objetivo:** Queries avanzadas

**Entregables:**

- Query Builder complejo
- Where clauses m√∫ltiples
- Joins y relaciones b√°sicas

### ‚ú® FASE POLISH (14:25-14:45) - 20 minutos

**Objetivo:** Eloquent avanzado

**Entregables:**

- Scopes personalizados
- Accessors/Mutators en acci√≥n
- Performance optimization

## üìã CORE: CRUD B√°sico con Eloquent

### 1. Create - Crear Registros

#### M√©todo 1: Instanciar y Guardar

```php
<?php
// Ejemplo b√°sico de CREATE

// Crear instancia del model
$producto = new App\Models\Producto();
$producto->nombre = 'Laptop Gaming ASUS';
$producto->descripcion = 'Laptop para gaming con RTX 4060';
$producto->precio = 3499000.00;
$producto->stock = 15;
$producto->activo = true;

// Guardar en base de datos
$producto->save();

echo "‚úÖ Producto creado con ID: " . $producto->id;
```

#### M√©todo 2: Create Masivo

```php
<?php
// CREATE usando fillable (m√°s eficiente)

$producto = App\Models\Producto::create([
    'nombre' => 'Samsung Galaxy S24',
    'descripcion' => 'Smartphone flagship con c√°mara IA',
    'precio' => 2899000.00,
    'stock' => 40,
    'activo' => true,
    'categoria' => 'electronica'
]);

echo "‚úÖ Producto creado: " . $producto->nombre;
```

#### M√©todo 3: Create con Validaci√≥n

```php
<?php
// CREATE con validaci√≥n de datos

try {
    $datosProducto = [
        'codigo_sku' => 'GAMER-001',
        'nombre' => 'Silla Gaming RGB',
        'descripcion' => 'Silla ergon√≥mica para gaming con luces RGB',
        'precio' => 899000.00,
        'peso' => 18.5,
        'stock' => 25,
        'categoria' => 'muebles',
        'activo' => true
    ];

    $producto = App\Models\Producto::create($datosProducto);
    echo "‚úÖ Producto creado exitosamente: {$producto->codigo_sku}";

} catch (Exception $e) {
    echo "‚ùå Error al crear producto: " . $e->getMessage();
}
```

### 2. Read - Leer Registros

#### Obtener Todos los Registros

```php
<?php
// READ - Obtener todos los productos

// Obtener todos (¬°CUIDADO en producci√≥n!)
$productos = App\Models\Producto::all();
echo "üì¶ Total productos: " . $productos->count();

// Obtener solo campos espec√≠ficos
$productos = App\Models\Producto::select('id', 'nombre', 'precio')->get();
foreach ($productos as $producto) {
    echo "‚Ä¢ {$producto->nombre}: \${$producto->precio}\n";
}
```

#### Obtener por ID

```php
<?php
// READ - Obtener producto espec√≠fico

// Por clave primaria
$producto = App\Models\Producto::find(1);
if ($producto) {
    echo "Producto encontrado: " . $producto->nombre;
} else {
    echo "Producto no encontrado";
}

// Por clave primaria (lanza excepci√≥n si no existe)
try {
    $producto = App\Models\Producto::findOrFail(999);
    echo $producto->nombre;
} catch (ModelNotFoundException $e) {
    echo "‚ùå Producto con ID 999 no existe";
}
```

#### B√∫squedas con Where

```php
<?php
// READ - B√∫squedas con condiciones

// Productos activos
$productosActivos = App\Models\Producto::where('activo', true)->get();
echo "Productos activos: " . $productosActivos->count();

// Productos con stock
$productosEnStock = App\Models\Producto::where('stock', '>', 0)->get();

// M√∫ltiples condiciones
$productosCaros = App\Models\Producto::where('precio', '>', 1000000)
                                     ->where('activo', true)
                                     ->where('stock', '>', 0)
                                     ->get();

// B√∫squeda por texto
$busqueda = App\Models\Producto::where('nombre', 'like', '%iPhone%')->get();
foreach ($busqueda as $producto) {
    echo "üì± {$producto->nombre} - {$producto->precio_formateado}\n";
}
```

### 3. Update - Actualizar Registros

#### Update Individual

```php
<?php
// UPDATE - Actualizar un producto

// M√©todo 1: Find y Save
$producto = App\Models\Producto::find(1);
if ($producto) {
    $producto->precio = 4599000.00;
    $producto->stock = 30;
    $producto->save();

    echo "‚úÖ Producto actualizado: " . $producto->nombre;
}

// M√©todo 2: Update directo
App\Models\Producto::where('id', 1)
                   ->update([
                       'precio' => 4599000.00,
                       'stock' => 30
                   ]);

echo "‚úÖ Producto actualizado mediante where";
```

#### Update Masivo

```php
<?php
// UPDATE - Actualizaci√≥n masiva

// Actualizar todos los productos de una categor√≠a
$productosActualizados = App\Models\Producto::where('categoria', 'electronica')
                                           ->update(['activo' => true]);

echo "‚úÖ {$productosActualizados} productos de electr√≥nica activados";

// Incrementar precios en 10%
App\Models\Producto::where('categoria', 'ropa')
                   ->increment('precio', 0.10);

echo "‚úÖ Precios de ropa incrementados 10%";
```

#### Update con Validaci√≥n

```php
<?php
// UPDATE con validaci√≥n y manejo de errores

try {
    $producto = App\Models\Producto::findOrFail(2);

    // Validar antes de actualizar
    if ($producto->stock < 10) {
        echo "‚ö†Ô∏è Advertencia: Stock bajo para {$producto->nombre}";
    }

    $producto->update([
        'descripcion' => 'Descripci√≥n actualizada con m√°s detalles',
        'peso' => 0.5,
        'categoria' => 'electronica_actualizada'
    ]);

    echo "‚úÖ Producto actualizado: " . $producto->nombre;

} catch (ModelNotFoundException $e) {
    echo "‚ùå Producto no encontrado para actualizar";
} catch (Exception $e) {
    echo "‚ùå Error al actualizar: " . $e->getMessage();
}
```

### 4. Delete - Eliminar Registros

#### Delete Individual

```php
<?php
// DELETE - Eliminar producto

// M√©todo 1: Find y Delete
$producto = App\Models\Producto::find(3);
if ($producto) {
    $nombreProducto = $producto->nombre;
    $producto->delete();
    echo "üóëÔ∏è Producto eliminado: {$nombreProducto}";
}

// M√©todo 2: Delete directo por ID
$eliminado = App\Models\Producto::destroy(4);
if ($eliminado) {
    echo "üóëÔ∏è Producto con ID 4 eliminado";
}

// M√©todo 3: Delete con where
$eliminados = App\Models\Producto::where('stock', 0)
                                 ->where('activo', false)
                                 ->delete();
echo "üóëÔ∏è {$eliminados} productos sin stock eliminados";
```

#### Delete con Validaci√≥n

```php
<?php
// DELETE con validaci√≥n de negocio

try {
    $producto = App\Models\Producto::findOrFail(5);

    // Validar si se puede eliminar
    if ($producto->stock > 0) {
        echo "‚ùå No se puede eliminar producto con stock: {$producto->nombre}";
        return;
    }

    // Guardar informaci√≥n antes de eliminar
    $info = [
        'nombre' => $producto->nombre,
        'precio' => $producto->precio,
        'eliminado_en' => now()
    ];

    $producto->delete();

    echo "‚úÖ Producto eliminado: " . $info['nombre'];
    echo "üìä Precio original: " . $info['precio'];

} catch (ModelNotFoundException $e) {
    echo "‚ùå Producto no encontrado para eliminar";
}
```

## ‚ö° ENHANCED: Query Builder Avanzado

### 1. Queries Complejas con Where

```php
<?php
// ENHANCED - Where clauses avanzadas

// Where con OR
$productos = App\Models\Producto::where('categoria', 'electronica')
                                ->orWhere('categoria', 'gaming')
                                ->get();

// Where anidado con grupos
$productos = App\Models\Producto::where(function ($query) {
                                     $query->where('precio', '<', 500000)
                                           ->where('stock', '>', 10);
                                 })
                                ->orWhere(function ($query) {
                                     $query->where('categoria', 'oferta')
                                           ->where('activo', true);
                                 })
                                ->get();

// Where con arrays (IN)
$categorias = ['electronica', 'gaming', 'informatica'];
$productos = App\Models\Producto::whereIn('categoria', $categorias)->get();

// Where con rangos
$productos = App\Models\Producto::whereBetween('precio', [100000, 1000000])->get();

// Where con NULL
$productosImagenes = App\Models\Producto::whereNotNull('imagen')->get();
$productosSinPeso = App\Models\Producto::whereNull('peso')->get();

echo "üìä Productos encontrados: " . $productos->count();
```

### 2. Ordenamiento y L√≠mites

```php
<?php
// ENHANCED - Ordenamiento y paginaci√≥n

// Ordenar por precio descendente
$productosCaros = App\Models\Producto::orderBy('precio', 'desc')
                                     ->take(5)
                                     ->get();

// Ordenar por m√∫ltiples campos
$productos = App\Models\Producto::orderBy('categoria', 'asc')
                                ->orderBy('precio', 'desc')
                                ->get();

// Obtener el m√°s caro y m√°s barato
$masCaro = App\Models\Producto::orderBy('precio', 'desc')->first();
$masBarato = App\Models\Producto::orderBy('precio', 'asc')->first();

echo "üí∞ M√°s caro: {$masCaro->nombre} - {$masCaro->precio_formateado}";
echo "üí∏ M√°s barato: {$masBarato->nombre} - {$masBarato->precio_formateado}";

// Paginaci√≥n manual
$pagina = 1;
$porPagina = 10;
$productos = App\Models\Producto::skip(($pagina - 1) * $porPagina)
                                ->take($porPagina)
                                ->get();
```

### 3. Agregaciones y Estad√≠sticas

```php
<?php
// ENHANCED - Funciones de agregaci√≥n

// Conteos
$totalProductos = App\Models\Producto::count();
$productosActivos = App\Models\Producto::where('activo', true)->count();
$productosPorCategoria = App\Models\Producto::groupBy('categoria')
                                           ->selectRaw('categoria, count(*) as total')
                                           ->get();

// Precios
$precioPromedio = App\Models\Producto::avg('precio');
$precioMinimo = App\Models\Producto::min('precio');
$precioMaximo = App\Models\Producto::max('precio');
$sumaTotal = App\Models\Producto::sum('precio');

// Stock
$stockTotal = App\Models\Producto::sum('stock');
$stockPromedio = App\Models\Producto::avg('stock');

echo "üìä ESTAD√çSTICAS DE PRODUCTOS:";
echo "Total productos: {$totalProductos}";
echo "Productos activos: {$productosActivos}";
echo "Precio promedio: $" . number_format($precioPromedio, 2);
echo "Stock total: {$stockTotal} unidades";

// Estad√≠sticas por categor√≠a
foreach ($productosPorCategoria as $stat) {
    echo "üè∑Ô∏è {$stat->categoria}: {$stat->total} productos";
}
```

### 4. B√∫squedas y Filtros Avanzados

```php
<?php
// ENHANCED - B√∫squedas complejas

// B√∫squeda full-text simulada
function buscarProductos($termino) {
    return App\Models\Producto::where('nombre', 'like', "%{$termino}%")
                              ->orWhere('descripcion', 'like', "%{$termino}%")
                              ->orWhere('codigo_sku', 'like', "%{$termino}%")
                              ->get();
}

// Filtros combinados
function filtrarProductos($filtros) {
    $query = App\Models\Producto::query();

    if (!empty($filtros['categoria'])) {
        $query->where('categoria', $filtros['categoria']);
    }

    if (!empty($filtros['precio_min'])) {
        $query->where('precio', '>=', $filtros['precio_min']);
    }

    if (!empty($filtros['precio_max'])) {
        $query->where('precio', '<=', $filtros['precio_max']);
    }

    if (!empty($filtros['solo_activos'])) {
        $query->where('activo', true);
    }

    if (!empty($filtros['con_stock'])) {
        $query->where('stock', '>', 0);
    }

    return $query->get();
}

// Ejemplos de uso
$resultados = buscarProductos('iPhone');
echo "üîç B√∫squeda 'iPhone': " . $resultados->count() . " resultados";

$filtrados = filtrarProductos([
    'categoria' => 'electronica',
    'precio_min' => 500000,
    'precio_max' => 2000000,
    'solo_activos' => true,
    'con_stock' => true
]);

echo "üéØ Productos filtrados: " . $filtrados->count();
```

## ‚ú® POLISH: Eloquent Avanzado

### 1. Usando Scopes del Model

```php
<?php
// POLISH - Usar scopes definidos en el Model

// Scopes b√°sicos
$activos = App\Models\Producto::activos()->get();
$enStock = App\Models\Producto::enStock()->get();
$disponibles = App\Models\Producto::disponibles()->get(); // activos Y en stock

// Scopes con par√°metros
$electronicos = App\Models\Producto::porCategoria('electronica')->get();
$busqueda = App\Models\Producto::buscarPorNombre('iPhone')->get();

// Combinando scopes
$productosVendibles = App\Models\Producto::activos()
                                        ->enStock()
                                        ->porCategoria('electronica')
                                        ->get();

echo "üéØ Productos vendibles: " . $productosVendibles->count();

// Scopes con ordenamiento
$mejoresProductos = App\Models\Producto::disponibles()
                                      ->orderBy('precio', 'desc')
                                      ->take(10)
                                      ->get();

foreach ($mejoresProductos as $producto) {
    echo "‚≠ê {$producto->nombre} - {$producto->precio_formateado}";
}
```

### 2. Accessors en Acci√≥n

```php
<?php
// POLISH - Usar accessors para datos formateados

$productos = App\Models\Producto::take(5)->get();

foreach ($productos as $producto) {
    echo "üì¶ PRODUCTO: {$producto->nombre}";
    echo "üí∞ Precio: {$producto->precio_formateado}"; // Accessor
    echo "üìä Stock: {$producto->estado_stock}"; // Accessor
    echo "üñºÔ∏è Imagen: {$producto->imagen_url}"; // Accessor
    echo "---";
}

// Accessor para calcular descuentos
$productos = App\Models\Producto::where('categoria', 'electronica')->get();

foreach ($productos as $producto) {
    $precioDescuento = $producto->aplicarDescuento(15); // M√©todo del model
    echo "{$producto->nombre}:";
    echo "  Precio normal: {$producto->precio_formateado}";
    echo "  Con 15% desc: $" . number_format($precioDescuento, 2);
}
```

### 3. Operaciones Avanzadas de Negocio

```php
<?php
// POLISH - M√©todos de negocio del model

// Gesti√≥n de inventario
$producto = App\Models\Producto::find(1);

if ($producto) {
    echo "üì¶ GESTI√ìN DE INVENTARIO para: {$producto->nombre}";
    echo "Stock actual: {$producto->stock}";

    // Verificar disponibilidad
    if ($producto->estaDisponible()) {
        echo "‚úÖ Producto disponible para venta";

        // Simular venta
        if ($producto->reducirStock(3)) {
            echo "‚úÖ Stock reducido en 3 unidades";
            echo "Stock actual: {$producto->stock}";
        }
    } else {
        echo "‚ùå Producto NO disponible";
    }

    // Verificar si necesita restock
    if ($producto->necesitaRestock(15)) {
        echo "‚ö†Ô∏è ALERTA: Producto necesita restock";

        // Agregar stock
        $producto->aumentarStock(20);
        echo "‚úÖ Stock aumentado en 20 unidades";
    }
}
```

### 4. Estad√≠sticas y Reports

```php
<?php
// POLISH - Estad√≠sticas usando m√©todos est√°ticos

// Estad√≠sticas generales
$stats = App\Models\Producto::obtenerEstadisticas();

echo "üìä REPORTE DE PRODUCTOS:";
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
echo "üì¶ Total productos: {$stats['total']}";
echo "‚úÖ Productos activos: {$stats['activos']}";
echo "üìà En stock: {$stats['en_stock']}";
echo "üéØ Disponibles: {$stats['disponibles']}";
echo "‚ùå Sin stock: {$stats['sin_stock']}";
echo "üí∞ Valor inventario: $" . number_format($stats['valor_inventario'], 2);
echo "üìä Precio promedio: $" . number_format($stats['precio_promedio'], 2);

// Obtener categor√≠as
$categorias = App\Models\Producto::obtenerCategorias();
echo "üè∑Ô∏è Categor√≠as disponibles: " . implode(', ', $categorias);

// B√∫squeda avanzada
$resultados = App\Models\Producto::buscarAvanzado([
    'nombre' => 'iPhone',
    'categoria' => 'electronica',
    'precio_min' => 1000000,
    'precio_max' => 5000000,
    'solo_activos' => true,
    'solo_en_stock' => true
])->get();

echo "üîç B√∫squeda avanzada: " . $resultados->count() . " resultados";
foreach ($resultados as $producto) {
    echo "  ‚Ä¢ {$producto->nombre} - {$producto->precio_formateado}";
}
```

## üß™ Verificaci√≥n Final y Testing

### Script de Verificaci√≥n Completo

```php
<?php
// TESTING - Script completo de verificaci√≥n

echo "üß™ TESTING ELOQUENT CRUD OPERATIONS";
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";

try {
    // TEST 1: CREATE
    echo "\nüîß TEST 1: CREATE";
    $nuevoProducto = App\Models\Producto::create([
        'codigo_sku' => 'TEST-' . time(),
        'nombre' => 'Producto de Testing',
        'descripcion' => 'Creado para verificar CRUD',
        'precio' => 99000.00,
        'stock' => 50,
        'categoria' => 'testing',
        'activo' => true
    ]);
    echo "‚úÖ CREATE exitoso - ID: {$nuevoProducto->id}";

    // TEST 2: READ
    echo "\nüìñ TEST 2: READ";
    $producto = App\Models\Producto::find($nuevoProducto->id);
    echo "‚úÖ READ exitoso - Nombre: {$producto->nombre}";
    echo "‚úÖ Accessor funcionando - Precio: {$producto->precio_formateado}";

    // TEST 3: UPDATE
    echo "\nüîÑ TEST 3: UPDATE";
    $producto->update([
        'precio' => 149000.00,
        'stock' => 75
    ]);
    echo "‚úÖ UPDATE exitoso - Nuevo precio: {$producto->precio_formateado}";

    // TEST 4: SCOPES
    echo "\nüéØ TEST 4: SCOPES";
    $activos = App\Models\Producto::activos()->count();
    $disponibles = App\Models\Producto::disponibles()->count();
    echo "‚úÖ SCOPES funcionando - Activos: {$activos}, Disponibles: {$disponibles}";

    // TEST 5: ESTAD√çSTICAS
    echo "\nüìä TEST 5: ESTAD√çSTICAS";
    $stats = App\Models\Producto::obtenerEstadisticas();
    echo "‚úÖ ESTAD√çSTICAS funcionando - Total: {$stats['total']}";

    // TEST 6: DELETE
    echo "\nüóëÔ∏è TEST 6: DELETE";
    $producto->delete();
    echo "‚úÖ DELETE exitoso - Producto eliminado";

    echo "\nüéâ TODOS LOS TESTS PASARON EXITOSAMENTE";

} catch (Exception $e) {
    echo "\n‚ùå ERROR EN TESTING: " . $e->getMessage();
}

echo "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ";
echo "üèÜ ELOQUENT CRUD OPERATIONS VERIFICADO";
```

## ‚úÖ Entregables de esta Secci√≥n

- [ ] CRUD b√°sico (Create, Read, Update, Delete) funcional
- [ ] Query Builder con where clauses complejas
- [ ] Agregaciones y estad√≠sticas implementadas
- [ ] Scopes del model en uso
- [ ] Accessors formateando datos autom√°ticamente
- [ ] M√©todos de negocio operativos
- [ ] B√∫squedas avanzadas funcionando
- [ ] Script de testing completo ejecutado

## üö® Troubleshooting Com√∫n

### Error: "Mass assignment not allowed"

```php
// Soluci√≥n: Verificar $fillable en el Model
protected $fillable = [
    'nombre', 'descripcion', 'precio', 'stock', 'activo'
];
```

### Error: "Class not found"

```bash
# Regenerar autoload
composer dump-autoload

# Verificar namespace
php artisan tinker
App\Models\Producto::first();
```

## ‚û°Ô∏è Preparaci√≥n para Secci√≥n 04

Una vez completada esta secci√≥n, tendr√°s:

‚úÖ Dominio completo de operaciones CRUD  
‚úÖ Query Builder avanzado funcionando  
‚úÖ Scopes y m√©todos de negocio activos  
‚úÖ Sistema de testing verificado

**Pr√≥ximo paso:** Implementar relationships b√°sicas (hasMany, belongsTo) en la Secci√≥n 04.
